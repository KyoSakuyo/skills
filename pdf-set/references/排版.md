CRITICAL: 按顺序执行以下阶段，勿跳步。

## 输入/输出
- 源文件通常在 `合并结果/`; 输出到 `排版结果/`（不存在就创建），文件名保持一致。

## 脚本参考

- 使用 `scripts/typeset.py` 完成排版处理。
- 默认按当前工作目录推导路径：
  - 输入：`<当前目录>/合并结果/`
  - 输出：`<当前目录>/排版结果/`
- 可选参数：
  - `--base-dir` 指定书籍目录
  - `--input-dir`/`--output-dir` 指定完整输入/输出目录
  - `--files` 指定处理的文件名列表（不传则处理输入目录内全部 `.md`）
  - `--files-from` 使用 UTF-8 文本文件提供文件名列表（每行一个）
  - `--file-indices` 按前缀序号匹配文件，如 `1.xxx.md`

示例：

```bash
python .agent/skills/pdf-set/scripts/typeset.py --base-dir "C:\path\to\book"
```

## 阶段 1：清理&合并断行

- **段落空行规则**：同一段内不留空行；段落之间留一行空行（两个换行符）。

- **行合并启发**（避免误合并标题/列表/引用）： 
  - 判断是「完整段落」还是「硬断行」的最直接依据：该段落的段首是否有两个空格字符的首行缩进（只有段首）；如果判断为否，则为硬断行，应将内容不加任何空格和空行地合并到上一个段落的结尾。
  
    示例：
  
    ```
      一个人活一辈子，竟然在所有关键时刻运气都这么差，让苏珊·桑塔格都忍不住给他算了星盘，并给英语版
    
    本雅明文集写出了《在土星的标志下》这篇著名的导言。如今，本雅明长眠西班牙波尔沃，他的墓碑上用德语和本地加泰罗尼亚语写着遗作《历史哲学论纲》里的一句话：“没有一座文明的丰碑不同时也是一份野蛮的实录”。
    ```
  
    或者：
  
    ```
      一个人活一辈子，竟然在所有关键时刻运气都这么差，让苏珊·桑塔格都忍不住给他算了星盘，并给英语版
    本雅明文集写出了《在土星的标志下》这篇著名的导言。如今，本雅明长眠西班牙波尔沃，他的墓碑上用德语和本地加泰罗尼亚语写着遗作《历史哲学论纲》里的一句话：“没有一座文明的丰碑不同时也是一份野蛮的实录”。
    ```
  
    或者：
  
    ```
      一个人活一辈子，竟然在所有关键时刻运气都这么差，让苏珊·桑塔格都忍不住给他算了星盘，并给英语版
      
    本雅明文集写出了《在土星的标志下》这篇著名的导言。如今，本雅明长眠西班牙波尔沃，他的墓碑上用德语和本地加
    
    泰罗尼亚语写着遗作《历史哲学论纲》里的一句话：“没有一座文明的丰碑不同时也是一份野蛮的实录”。
    ```
  
    
  
    无论中间是一个换行符或是两个换行符构成的空行；无论这中间有一个空行还是两个空行，因为它的段首没有两个空格字符的首行缩进，它都是「硬断行」的「残段」。
  
    你需要合并为：
  
    ```
      一个人活一辈子，竟然在所有关键时刻运气都这么差，让苏珊·桑塔格都忍不住给他算了星盘，并给英语版本雅明文集写出了《在土星的标志下》这篇著名的导言。如今，本雅明长眠西班牙波尔沃，他的墓碑上用德语和本地加泰罗尼亚语写着遗作《历史哲学论纲》里的一句话：“没有一座文明的丰碑不同时也是一份野蛮的实录”。
    ```
  
  - 对中英文断词：行尾连字符分词移除连字符再合并；中文被硬换行的直接拼接。
  - 合并之后别忘了再检查和下一段之间是否符合空行规则：同一段内不留空行；段落之间留一行空行（两个换行符）。
  - 保留首行缩进。

## 阶段 2：注释无空行

- 像是
```
<sup>【②［见前文 025 页注①］这个字的两种用法，可由一些极端的举例中看出来：词组“mein seliger Vater”［先父］以及从《唐乔凡尼》（Don Giovanni）的二重唱［德文版的“让我们手挽着手”（Làci darem）］所摘录的这些句子：

  啊，这将永远会是你的——

  我会多么的幸福！

  [Ah, to be thing for ever —

  How blissful I should be!]

  事实上，在我们的语言中，相同的字竟然会用在截然不同的情境下，这并不是没有意义的。】</sup>
```
被<sup></sup>标签包括着的注释，你需要删除其中空行，保证注释只有一段，变成：
```
<sup>【②［见前文 025 页注①］这个字的两种用法，可由一些极端的举例中看出来：词组“mein seliger Vater”［先父］以及从《唐乔凡尼》（Don Giovanni）的二重唱［德文版的“让我们手挽着手”（Làci darem）］所摘录的这些句子：
  啊，这将永远会是你的——
  我会多么的幸福！
  [Ah, to be thing for ever —
  How blissful I should be!]
  事实上，在我们的语言中，相同的字竟然会用在截然不同的情境下，这并不是没有意义的。】</sup>
```

## 阶段 3：收尾检查
- 通读确认：段落分隔正确；无断行。
- 输出：将排版后的文件写入 `排版结果/同名文件`。如需在其他目录，保持相同文件名和 UTF-8 编码。
