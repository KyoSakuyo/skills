CRITICAL: 
每个batch只处理一张图！analyze完该张图的内容后,再analyze它前后的md文件，再输出对应的md文件。

每次batch的plan应该是(举例)：
1. Analyze 20.jpg
2. Analyze 19.md
3. Analyze 21.md
4. Think about the content boundary of 20.jpg based on 19.md and 21
5. Output 20.md

时刻注意每份文档的内容，忠实还原一张图片的**全部**内容，一张，不要多也不要少。该张图片的**所有段落**的**所有字符**都要原封不动地输出，如果该张图结束在一个残句断词──原封不动地把它输出！别省略掉！不要看到注释就停止输出！
你要参考前后的md文件的内容，思考该组图片的每一张图片的开头和结尾是否和前后文衔接上，思考语言风格是否一致，思考简繁体是否一致。
时刻注意段落分段的原则和首行缩进和注释规则。
时刻记住一旦识别到配图就需要用 🀄代替图片。
时刻记住你生成的「原图序号.md」的文档要和「原图序号.jpg」的**图片文件名**对应，不要被书内的页码迷惑。你analyze完图片200.jpg后，把200.jpg的内容严格对应在200.md中，全部输出。

用户告诉你执行OCR查漏补缺时，先运行脚本输出待处理清单：脚本扫描`ocr-result`文件夹筛选后缀为原图序号`.fail.md`的文件，并输出对应图片路径「原书名/图片/序号.jpg」；只对脚本输出的这些图片进行OCR。

注意：你不可以做出I've also found that 
108.md is empty, indicating it also needs to be re-processed. I'm now checking other suspicious files like 113.md and 36.md 这样的思考，不需要你去处理空文件，空文件代表了原图无内容。你只需要去处理脚本输出的图片。

## 输入/输出

1. **输入与批次规则**
   - 运行脚本生成待处理清单，只处理脚本输出的图片路径条目（格式：`原书名/图片/序号.jpg`）。
   - 读取图片并进行 OCR。
   - 你的Analyze&Think的过程中，需要思考：
      - 这一组的这张图的最后一个字符是什么──你输出的文档必须以这个字符结束。
      - 前一个序号的md文件的末尾是否能该序号图片的开头衔接上。
      - 后一个序号的md文件的开头是否能和该序号图片的结尾衔接上。
      - 你所使用的语言要和上下序号的md文件中的语言一致（简体/繁体）。
      - 所生成的文件的开头结尾要严格对应上每一组图片的正文部分的**最初的内容**与**最后的内容**。
      - 思考是否存在配图（参考下文配图替代原则）。
      - 思考注释的转移（参考下文注释转移原则）。
   - **所有图片 think 完成后**，再统一输出对应文件。
2. **输出规则**
   - 输出目录为`ocr-result`文件夹；若不存在则新建。
   - 一张图片必须生成一个与之 **名称对应** 的 Markdown 文件，命名为「原图序号.md」。举例：200.md，不要删除原图序号.fail.md文件。

## 脚本参考

- 使用 `scripts/list_fail_md.py` 输出需要处理的图片清单（格式：`原书名/图片/序号.jpg`）。
- 默认按当前工作目录推导路径：
  - 输入：`<当前目录>/ocr-result/`
  - 输出：终端逐行打印待处理图片路径（默认相对路径）
- 可选参数：
  - `--base-dir` 指定书籍目录
  - `--ocr-dir` 指定 `ocr-result` 目录
  - `--basename-only` 仅输出文件名

示例：

```bash
python .agent/skills/pdf-set/scripts/list_fail_md.py --base-dir "C:\path\to\book"
```
3. **正文字符边界原则（核心）**
   - 对每组图片，必须明确识别：
     - 正文**最初的内容**
     - 正文**最后的内容**
- `.md` 文件内容 **必须严格从该页正文部分最初的字符开始，到该页最后的字符为止**──标点符号都不要补。
   - **避免**：
     - 从该组的上一页或下一页补内容
   - **禁止**
     - 猜测、推断、补全句意
     - 更禁止漏段！一点都不能漏！
4. **断句与不完整文本处理**
   - 若正文结尾为「，」「、」「：」等明显未完结符号：
     - **保持原样输出**
     - **不得修改、补写或续接**
   - 上一组的内容只属于上一组的 `.md`，下一页同理。
   - **不允许从下一组调取内容补写上一组**，更不能随便瞎编！！
5. **原则总结**
   - **完全尊重图片的内容边界**。
   - 不改写、不补全、不润色、不推断。

如果该页的结尾只有半句，像是
  由于弗洛伊德这些观点，经由梦的指引，穿过一层又一层的阻
你不要删掉！不要漏掉！！更不要在两份文件中重复出现！更不要把他后面补字。

如果有超过半句的，不要留到下一页！！


## 阶段 1：清理（必须删除）
- 页码（包括页眉/页脚的页码）。
- 边码 / 边栏编号。
- 每页页眉页脚中重复出现的章节标题名。

## OCR 识别规则
1. **字符忠实**：简体保持简体，繁体保持繁体；不要做简繁转换。不要变成文言文。更不要给原文换语言，不要把原书中的「他」换成「he」，把「和」换成「and」，把「的」换成「of」或者「의 」，不要把「了」换成「ました」…… 与此同时，保持原文的完整性，不可以增减掉和改写任何该页正文的内容。
2. **版式剔除**：删除页眉/页脚页码、边码/边栏数字、每页重复的章节标题。
3. **复杂图形处理**：
   - 简单数学/希腊字母可用 LaTeX，例如：`($S(\\cancel{A})$)`, `\\sigma`, `$p^o$`。
   - 当复杂公式/图示/配图无法文本化时，**跳过内容**，但在对应位置插入 `🀄️，该页页码` 标记。（要注意，页码应该是在图片中出现的页眉或者页尾的页码。）
   - **禁止**使用 Markdown 图片语法；只用 `🀄️，该页页码`表示图片。
   - 注意，`🀄️，该页页码`只是提示符，提示该位置有图片，以便我在正文中手动插入图片。

## 排版规则
### 分段规则
- 分段：段落间用两个换行符`\n\n`换行；
- 段内不用`\n`空行，连续输出所有内容。
- 每页输出结尾不留空行。

  错误示例1：

   ```
     恶与罪在暴民心理中的吸引力早已有之。暴民一向会欢迎“暴
       
   ```
  错误示例2：

   ```
     恶与罪在暴民心理中的吸
     引力早已有之。暴民一向会欢迎“暴
       
   ```
  需要以：

   ```
     恶与罪在暴民心理中的吸引力早已有之。暴民一向会欢迎“暴
   ```

   的形式直接结束该页。

- 标题：章节标题或小标题用二级标题 ##；禁止一级/三级标题(目录中的标题不用加##)
- 文本样式：加粗/斜体/特殊样式一律还原为纯文本。


### 首行缩进：
  - 以内容的连贯性和排版的空行位置判断该段落是否是新段落，新段段首加两个空格首行缩进。
  - 如果是一连串注释或者正文中列举，或者类似于参考资料中的人名或参考书目列举，你统一给每个不同内容之间都加新行，并且做首行缩进。
  - 若为上一页断段续接（通常无首行缩进且句意未完），则不要缩进。
#### 图片开头段落处理（格外注意）
  - 检查该页图片的开头是否有首行缩减的两个空格，如果它有，则说明它是新段落的开始，必须加首行缩进。
  若没有，判断该段为上一页结束处断开的段落之续接部分──续接部分通常会在图片中**没有**首行缩进（空两个空格的效果），而且句意通常都没有说完，不完整，没有完整主谓宾──则不要加首行缩进──对于这一点你可以处理地激进些，如果你不确定是否为续接部分，你就当它是续接部分，不要加首行缩进。
  - 对话体/诗歌/列表/特殊格式……：每人对话间留空行，每新行都缩进。
  - 不在正文内，单独成段的`🀄️，该页页码`也需要首行缩进
  -  不在正文内，单独成段的<sup>标签也要首行缩进

示例：

```
……上一段落结尾
（空行）
  下一段落开头
```
### 注释转移

#### 处理尾注 Endnote：不转移
若页脚无注释内容但是正文有标号──则这是尾注 Endnotes类型的书籍：
  - 不删除文内注号；
  - 文内注号改为 <sup>【原注号】</sup> 形式；不加入任何注释内容。

处理章节末尾注的标准：
  - 尾注内容保持原样，不做内嵌或清理。
  - 注释间保留空行。
  - 不需要sup标签

### 处理脚注 Footnote ：脚注转移
- 若页脚有脚注：把脚注文本移到正文中对应注号后，用 <sup>【】</sup> 包裹，并删除原注号与页脚脚注。
- 注释不得分段；原图注释如分段，需合并为一段。

举例：

```
1938-1950年的理論，中的症狀端賴著拉岡最後在1950年清楚標呼為「伊底帕斯主義的社會情況」，14-2 其論點後來成為主體成熟理論的軸心，主要圍繞在父親原相，這原相的結構化價值，跟家庭中的父親所具的社會價值有直接的關聯；其次，與家庭是否整合於社會也息息相關。
……
14-2 Op. cit., p.136.15-1 馬林諾斯基（B. Malinowski 1884-1942）人類學家，功能主義奠基者之一。他對性行為的研究讓他成為這領域的先鋒者，主要是研究超布連（Trobriand）群島的美拉尼西亞人。

特別參考《性以及它在原始社會的壓抑》（La sexualité et sa repression dans les sociétés primi-tives, Paris, Payot, 1932)。
```

你帮我处理为：

```
1938-1950年的理論，中的症狀端賴著拉岡最後在1950年清楚標呼為「伊底帕斯主義的社會情況」，<sup>【Op. cit., p.136.15-1 馬林諾斯基（B. Malinowski 1884-1942）人類學家，功能主義奠基者之一。他對性行為的研究讓他成為這領域的先鋒者，主要是研究超布連（Trobriand）群島的美拉尼西亞人。
特別參考《性以及它在原始社會的壓抑》（La sexualité et sa repression dans les sociétés primi-tives, Paris, Payot, 1932)。】</sup>其論點後來成為主體成熟理論的軸心，主要圍繞在父親原相，這原相的結構化價值，跟家庭中的父親所具的社會價值有直接的關聯；其次，與家庭是否整合於社會也息息相關。
```

   注意：注释中不可以分段；即使原图中的注释是分段的，你就把它们合并为一段。

- 若注释末尾为「接下页」「-」「接下页注」或明显未完：在注释末尾加 ⬇️。
- 若页脚出现无标号且像是续上页的注释（可能有「续上页/续上页注/接上页注」或无注号）;
  或者是出现了注释，但是对应的标号不在本页（可能在上一页）；
  你需要：
  放在正文最前，用下面方法分隔(注意：空行、emoji、首行缩进的两个空格)：
```
  <sup>⬆️……</sup>

```

### 输出检查
- 段落与标题格式符合上述规则。
- 无 Markdown 图片语法。
- 输出语言符合原文
- 不混入上一页或下一页内容。
